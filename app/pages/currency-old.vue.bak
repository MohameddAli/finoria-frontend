<template>
  <v-container id="Currency" fluid tag="section">
    <div>
      <v-card class="my-4 mx-auto">
        <v-card-title>
          <div class="d-flex justify-space-between align-center">
            <div>{{ $t('pages.currency.title') }}</div>
            <div class="d-flex">
              <v-btn fab small color="primary" @click="openAddDialog" :aria-label="$t('pages.currency.add')">
                <v-icon color="white">mdi-plus</v-icon>
              </v-btn>
            </div>
          </div>
        </v-card-title>

        <!-- Add/Edit Currency Dialog -->
        <v-dialog v-model="dialogOpen" max-width="800px">
          <v-card>
            <v-card-title>{{ dialogMode === 'add' ? t('pages.currency.add') : t('pages.currency.edit') }}</v-card-title>
            <v-card-text>
              <v-form class="px-3" @submit.prevent="submitCurrency">
                <v-row class="pt-3">
                  <v-col cols="12" sm="6">
                    <v-text-field v-model="form.name" :label="t('attributes.currency')" required />
                  </v-col>
                  <v-col cols="12" sm="6">
                    <v-text-field v-model="form.code" :label="t('attributes.code')" />
                  </v-col>
                  <v-col cols="12" sm="6">
                    <v-text-field v-model="form.symbol" :label="t('attributes.symbol')" />
                  </v-col>
                  <v-col cols="12" sm="6">
                    <v-text-field v-model.number="form.exchange_rate" :label="t('attributes.exchange_rate')" type="number" step="0.0001" min="0" />
                  </v-col>
                  <v-col cols="12" sm="6">
                    <v-switch v-model="form.is_active" :label="t('pages.users.active')" color="primary" hide-details />
                  </v-col>
                </v-row>
                <v-divider />
                <div class="d-flex justify-end mt-4">
                  <v-btn color="primary" type="submit">{{ t('common.save') }}</v-btn>
                  <v-btn variant="outlined" @click="closeDialog">{{ t('common.cancel') }}</v-btn>
                </div>
              </v-form>
            </v-card-text>
          </v-card>
        </v-dialog>

        <v-card-text>
          <v-divider />

          <!-- Column Visibility Selector -->
          <div class="px-4 mb-2">
            <ColumnVisibilitySelector
              v-model="selectedHeaders"
              :columns="allHeaders"
              :default-visible-columns="defaultVisibleColumns"
              :label="t('common.show_columns') || 'Show Columns'"
              :select-all-text="t('common.all') || 'Select All'"
              :clear-all-text="t('common.clear') || 'Clear All'"
              :search-placeholder="t('common.search') + '...' || 'Search columns...'"
              :no-results-text="t('common.no_results') || 'No columns found'"
              button-color="primary"
              button-variant="outlined"
              @change="handleColumnChange"
            />
          </div>

          <v-divider />

          <!-- Filter Panel -->
          <FilterPanel
            v-model="currencyFilters"
            :fields="currencyFilterFields"
            :toggle-button-label="t('common.filter')"
            :submit-button-label="t('common.search')"
            :clear-button-label="t('common.clear')"
            :active-filters-label="t('common.active')"
            button-color="primary"
            submit-button-color="primary"
            @submit="applyCurrencyFilters"
            @clear="clearCurrencyFilters"
          />

          <!-- Currency table -->
          <v-data-table
            :headers="tableHeaders"
            :items="displayedCurrencies"
            :items-per-page="pageSize"
            hide-default-footer
            class="elevation-1"
          >
            <template #item.is_active="{ item }">
              <v-icon :color="item.is_active ? 'green' : 'red'">
                {{ item.is_active ? 'mdi-check' : 'mdi-close' }}
              </v-icon>
            </template>
            <template #item.actions="{ item, index }">
              <div style="width: 140px" class="d-flex gap-2">
                <v-btn x-small fab color="primary" class="mr-1" @click="openEditDialog(index)">
                  <v-icon color="white">mdi-pencil</v-icon>
                </v-btn>
                <v-btn x-small fab color="error" class="mr-1" @click="confirmDelete(index)">
                  <v-icon color="white">mdi-delete</v-icon>
                </v-btn>
              </div>
            </template>
          </v-data-table>

          <!-- Delete confirmation dialog (reusable) -->
          <AppConfirmDialog
            v-model="deleteDialogOpen"
            :title="t('common.confirmDeleteTitle')"
            :message="t('common.confirmDeleteMessage')"
            icon="mdi-delete"
            icon-color="error"
            :confirm-text="t('common.yes')"
            confirm-color="error"
            @confirm="performDelete"
          />

          <!-- Pagination -->
          <div class="d-flex justify-end mt-4">
            <AppPagination
              :page="page"
              :length="totalPages"
              :total-items="rows.length"
              :page-size="pageSize"
              :page-sizes="[5, 10, 20, 50, 100]"
              :total-visible="5"
              :dense="false"
              :disabled="false"
              :show-page-size="true"
              :show-range="true"
              :show-first-last="true"
              :color="paginationColor"
              align="end"
              size="small"
              variant="outlined"
              @update:page="handleUpdatePage"
              @update:page-size="handleUpdatePageSize"
            />
          </div>
        </v-card-text>
      </v-card>
    </div>
  </v-container>
</template>

<script setup lang="ts">
// @ts-nocheck
import AppPagination from '~/components/pagination/AppPagination.vue'
import AppConfirmDialog from '~/components/ui/AppConfirmDialog.vue'
import FilterPanel from '~/components/filters/FilterPanel.vue'
import ColumnVisibilitySelector from '~/components/table/ColumnVisibilitySelector.vue'

definePageMeta({
  layout: 'dashboard',
  title: 'pages.currency.title',
  subtitle: 'pages.currency.subtitle'
})

const { t } = useI18n()

// Column visibility state
const selectedHeaders = ref([])
const defaultVisibleColumns = ['id', 'name', 'code', 'symbol', 'exchange_rate', 'is_active', 'actions']

// Dialog state
const dialogOpen = ref(false)
const dialogMode = ref('add') // 'add' | 'edit'
const editingIndex = ref(null) // number | null
const deleteDialogOpen = ref(false)
const pendingDeleteIndex = ref(null) // number | null

// Pagination
const page = ref(1)
const pageSize = ref(10)

// Filter state
const currencyFilters = ref({
  name: '',
  code: '',
  symbol: '',
  exchange_rate_min: '',
  exchange_rate_max: '',
  is_active: ''
})

// Filter fields configuration
const currencyFilterFields = [
  {
    name: 'name',
    type: 'text',
    label: t('attributes.currency'),
    placeholder: t('search.enter_currency_name') || 'Enter currency name',
    cols: 12,
    sm: 6,
    lg: 4
  },
  {
    name: 'code',
    type: 'text',
    label: t('attributes.code'),
    placeholder: 'e.g., USD',
    cols: 12,
    sm: 6,
    lg: 4
  },
  {
    name: 'symbol',
    type: 'text',
    label: t('attributes.symbol'),
    placeholder: 'e.g., $',
    cols: 12,
    sm: 6,
    lg: 4
  },
  {
    name: 'exchange_rate_min',
    type: 'number',
    label: 'Min Exchange Rate',
    cols: 12,
    sm: 6,
    lg: 3
  },
  {
    name: 'exchange_rate_max',
    type: 'number',
    label: 'Max Exchange Rate',
    cols: 12,
    sm: 6,
    lg: 3
  },
  {
    name: 'is_active',
    type: 'select',
    label: t('attributes.status'),
    items: [
      { title: t('common.active'), value: 'active' },
      { title: t('common.inactive'), value: 'inactive' }
    ],
    cols: 12,
    sm: 6,
    lg: 3
  }
]

/**
 * CurrencyRow type:
 * {
 *   id: string
 *   name: string
 *   code: string | null
 *   symbol: string
 *   exchange_rate: number
 *   is_active: boolean
 *   created_at?: string
 *   updated_at?: string
 * }
 */

// Seed with provided example + a couple more
const allRows = ref([
  {
    id: '1',
    name: 'دينار ليبي',
    code: null,
    symbol: 'د.ل',
    exchange_rate: 7.5,
    is_active: true,
    created_at: '2025-10-15 11:06:28',
    updated_at: '2025-10-15 11:06:28'
  },
  {
    id: '2',
    name: 'US Dollar',
    code: 'USD',
    symbol: '$',
    exchange_rate: 1,
    is_active: true,
    created_at: '2025-10-16 10:00:00',
    updated_at: '2025-10-16 10:00:00'
  },
  {
    id: '3',
    name: 'Euro',
    code: 'EUR',
    symbol: '€',
    exchange_rate: 0.92,
    is_active: false,
    created_at: '2025-10-16 11:00:00',
    updated_at: '2025-10-16 11:00:00'
  }
])

// Form model
const form = reactive({ id: '', name: '', code: null, symbol: '', exchange_rate: 1, is_active: true })

// All available headers (for column selector)
const allHeaders = computed(() => ([
  { title: t('attributes.id'),            key: 'id',             width: 100, align: 'start', sortable: true },
  { title: t('table.company'),            key: 'name',           width: 200, align: 'start', sortable: true },
  { title: t('attributes.code'),          key: 'code',           width: 120, align: 'start', sortable: true },
  { title: t('attributes.symbol'),        key: 'symbol',         width: 120, align: 'start', sortable: true },
  { title: t('attributes.exchange_rate'), key: 'exchange_rate',  width: 150, align: 'start', sortable: true },
  { title: t('attributes.status'),        key: 'is_active',      width: 120, align: 'center', sortable: true },
  { title: t('attributes.created_at'),    key: 'created_at',     width: 180, align: 'start', sortable: true },
  { title: t('attributes.updated_at'),    key: 'updated_at',     width: 180, align: 'start', sortable: true },
  { title: t('common.actions'),           key: 'actions',        width: 140, align: 'center', sortable: false },
]))

// Filtered data based on filter values
const filteredRows = computed(() => {
  let result = [...allRows.value]
  
  // Apply name filter
  if (currencyFilters.value.name) {
    result = result.filter(row => 
      row.name.toLowerCase().includes(currencyFilters.value.name.toLowerCase())
    )
  }
  
  // Apply code filter
  if (currencyFilters.value.code) {
    result = result.filter(row => 
      row.code && row.code.toLowerCase().includes(currencyFilters.value.code.toLowerCase())
    )
  }
  
  // Apply symbol filter
  if (currencyFilters.value.symbol) {
    result = result.filter(row => 
      row.symbol.toLowerCase().includes(currencyFilters.value.symbol.toLowerCase())
    )
  }
  
  // Apply min exchange rate filter
  if (currencyFilters.value.exchange_rate_min) {
    const min = parseFloat(currencyFilters.value.exchange_rate_min)
    if (!isNaN(min)) {
      result = result.filter(row => row.exchange_rate >= min)
    }
  }
  
  // Apply max exchange rate filter
  if (currencyFilters.value.exchange_rate_max) {
    const max = parseFloat(currencyFilters.value.exchange_rate_max)
    if (!isNaN(max)) {
      result = result.filter(row => row.exchange_rate <= max)
    }
  }
  
  // Apply status filter
  if (currencyFilters.value.is_active) {
    const isActive = currencyFilters.value.is_active === 'active'
    result = result.filter(row => row.is_active === isActive)
  }
  
  return result
})

// Use allRows for compatibility with existing code
const rows = filteredRows

// Visible headers based on selected columns
const tableHeaders = computed(() => {
  if (!selectedHeaders.value || selectedHeaders.value.length === 0) {
    return allHeaders.value.filter(h => defaultVisibleColumns.includes(h.key))
  }
  return selectedHeaders.value
})

// Pagination computed
const totalPages = computed(() => Math.max(1, Math.ceil(filteredRows.value.length / pageSize.value)))
const displayedCurrencies = computed(() => {
  const start = (page.value - 1) * pageSize.value
  const end = start + pageSize.value
  return filteredRows.value.slice(start, end)
})
const paginationColor = computed(() => 'primary')

// Dialog controls
const openAddDialog = () => {
  dialogMode.value = 'add'
  editingIndex.value = null
  Object.assign(form, { id: '', name: '', code: null, symbol: '', exchange_rate: 1, is_active: true })
  dialogOpen.value = true
}

const openEditDialog = (index) => {
  dialogMode.value = 'edit'
  editingIndex.value = index + (page.value - 1) * pageSize.value
  const row = rows.value[editingIndex.value]
  Object.assign(form, { ...row })
  dialogOpen.value = true
}

const closeDialog = () => { dialogOpen.value = false }

// Submit and Delete
const submitCurrency = () => {
  if (dialogMode.value === 'add') {
    const newId = String(Date.now())
    rows.value.unshift({ ...form, id: newId })
  } else if (dialogMode.value === 'edit' && editingIndex.value !== null) {
    rows.value[editingIndex.value] = { ...form }
  }
  // Build requested query for reference
  // /admin/currencies?name=...&symbol=...&exchange_rate=...&is_active=1&code=...
  const query = new URLSearchParams({
    name: form.name,
    symbol: form.symbol,
    exchange_rate: String(form.exchange_rate),
    is_active: form.is_active ? '1' : '0',
    code: form.code ?? ''
  }).toString()
  console.log(`/admin/currencies?${query}`)
  closeDialog()
}

const deleteRow = (index) => {
  const absoluteIndex = index + (page.value - 1) * pageSize.value
  rows.value.splice(absoluteIndex, 1)
  if ((page.value - 1) * pageSize.value >= rows.value.length && page.value > 1) {
    page.value -= 1
  }
}

const confirmDelete = (index) => {
  pendingDeleteIndex.value = index
  deleteDialogOpen.value = true
}

const performDelete = () => {
  if (pendingDeleteIndex.value === null) {
    deleteDialogOpen.value = false
    return
  }
  deleteRow(pendingDeleteIndex.value)
  pendingDeleteIndex.value = null
  deleteDialogOpen.value = false
}

// Filter handlers
const applyCurrencyFilters = (filterValues) => {
  console.log('Applying currency filters:', filterValues)
  // Filters are automatically applied via filteredRows computed property
  // Reset to first page when filters change
  page.value = 1
}

const clearCurrencyFilters = () => {
  console.log('Currency filters cleared')
  // Reset to first page when filters cleared
  page.value = 1
}

// Pagination handlers
const handleUpdatePage = (newPage) => { page.value = newPage }
const handleUpdatePageSize = (newPageSize) => { pageSize.value = newPageSize; page.value = 1 }

// Column visibility handler
const handleColumnChange = (columns) => {
  console.log('Visible columns changed:', columns.map(c => c.key))
}
</script>

<style scoped>
.v-data-table { margin-top: 16px; }

::deep(.v-data-table thead th) {
  background-color: rgba(var(--v-theme-surface-variant), 0.3);
  font-weight: 600;
  font-size: 0.875rem;
  color: rgb(var(--v-theme-on-surface-variant));
  border-bottom: 1px solid rgba(var(--v-border-color), 0.12);
}

::deep(.v-data-table tbody tr:hover) {
  background-color: rgba(var(--v-theme-surface-variant), 0.1);
}
</style>

